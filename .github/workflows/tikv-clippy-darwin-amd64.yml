name: Clippy (Darwin AMD64)

env:
  CMAKE_VERSION: "3.28.0"

on:
  pull_request:
    branches:
      - master
      - 'feature/**'
    paths-ignore:
      - '**.md'
      - '**.png'
      - '**.jpeg'
      - '**.jpg'
      - '**.gif'
      - '**.svg'
      - '**.pdf'
      - '.gitignore'
      - 'Dockerfile'
      - 'OWNERS'
      - 'OWNERS_ALIASES'

permissions:
  contents: read

jobs:
  clippy:
    name: Run Clippy on macOS
    runs-on: macos-15-intel
    timeout-minutes: 120

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Install CMake 3.28
        env:
          CMAKE_VERSION: ${{ env.CMAKE_VERSION }}
        run: |
          CMAKE_VERSION="${{ env.CMAKE_VERSION }}"
          CMAKE_URL="https://github.com/Kitware/CMake/releases/download/v${CMAKE_VERSION}/cmake-${CMAKE_VERSION}-macos-universal.tar.gz"
          
          cd /tmp
          curl -L -o cmake.tar.gz "${CMAKE_URL}"
          tar -xzf cmake.tar.gz
          
          sudo mkdir -p /usr/local/bin
          sudo mkdir -p /usr/local/share
          sudo cp -R cmake-${CMAKE_VERSION}-macos-universal/CMake.app/Contents/bin/* /usr/local/bin/
          sudo cp -R cmake-${CMAKE_VERSION}-macos-universal/CMake.app/Contents/share/* /usr/local/share/ || true
          
          echo "/usr/local/bin" >> $GITHUB_PATH
          echo "CMAKE=/usr/local/bin/cmake" >> $GITHUB_ENV

          rm -rf cmake.tar.gz "cmake-${CMAKE_VERSION}-macos-universal"
          
          /usr/local/bin/cmake --version
          echo "CMake ${CMAKE_VERSION} installed"

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: nightly-2025-02-28
          components: rustfmt,clippy,rust-src,rust-analyzer

      - name: Cache Cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Run Clippy
        run: |
          make clippy
